<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Aulas</title>
    <!-- Usando a fonte Inter para uma aparência mais moderna --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* NOVA PALETA DE CORES - Tons de verde-azulado, cinzas e toques suaves */
        :root {
            --color-primary: #38a798; /* Verde-azulado principal */
            --color-primary-dark: #2c8276; /* Verde-azulado mais escuro */
            --color-secondary: #607d8b; /* Cinza azulado para detalhes */
            --color-success: #4caf50; /* Verde para sucesso */
            --color-danger: #e57373; /* Vermelho suave para perigo/excluir */
            --color-light: #f4f6f9; /* Fundo geral muito claro */
            --color-dark: #37474f; /* Texto principal (quase preto) */
            --color-border: #e0e0e0; /* Borda suave */
            --color-accent-light: #e0f2f1; /* Verde-azulado claro para fundo secundário */
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.08); /* Sombra mais leve */
            --shadow-hover: 0 4px 8px rgba(0, 0, 0, 0.12); /* Sombra ao passar o mouse */
            --border-radius: 8px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            /* Fundo com gradiente sutil */
            background: linear-gradient(170deg, var(--color-light) 0%, #eef1f5 100%);
            color: var(--color-dark);
            line-height: 1.6;
            margin: 0;
            padding: 1rem;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 1.5rem;
            background-color: #ffffff; /* Container principal é um card branco */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
        }

        h1, h2, h3 {
            color: var(--color-dark);
            margin-top: 0;
        }

        h1 {
            text-align: center;
            /* Cor primária como fallback */
            color: var(--color-primary); 
            /* Gradiente de texto */
            background: linear-gradient(45deg, var(--color-primary-dark), var(--color-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            
            margin-bottom: 1.5rem;
            display: flex; /* Alinhar ícone e texto */
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        /* Ícone do H1 usa a cor sólida */
        h1 svg {
            -webkit-text-fill-color: var(--color-primary);
        }
        
        h2 {
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            display: flex; /* Novo: alinhar ícone e texto no H2 */
            align-items: center;
            gap: 8px;
        }
        h2 svg {
            width: 22px;
            height: 22px;
            stroke: var(--color-primary);
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Novo: Layout de grade de volta */
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        /* Layout responsivo para telas maiores */
        @media (min-width: 768px) {
            .grid-layout {
                grid-template-columns: 300px 1fr;
            }
        }

        /* Seções de volta ao normal */
        .form-section, .schedule-section {
            padding: 0; 
            border: none;
            box-shadow: none;
            background-color: transparent;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--color-primary-dark);
            outline: none;
            box-shadow: 0 0 0 2px rgba(56, 167, 152, 0.2); /* Sombra suave ao focar */
        }

        .form-group input[type="number"] {
            -moz-appearance: textfield;
        }
        .form-group input[type="number"]::-webkit-outer-spin-button,
        .form-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-align: center;
            flex-grow: 1;
        }

        .btn-primary {
            /* Botão com gradiente */
            background: linear-gradient(45deg, var(--color-primary-dark), var(--color-primary));
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, var(--color-primary), var(--color-primary-dark));
            box-shadow: var(--shadow-hover);
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            box-shadow: var(--shadow-light);
        }

        .btn-danger, .btn-edit {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin-left: 0.5rem;
            flex-grow: 0;
            border-radius: 4px; /* Botões menores, bordas um pouco menores */
        }
        
        .btn-danger {
            background-color: var(--color-danger);
            color: white;
        }
        .btn-danger:hover { background-color: #c82333; }

        .btn-edit {
            background-color: #ffc107; /* Amarelo padrão para editar */
            color: var(--color-dark);
        }
        .btn-edit:hover { background-color: #e0a800; }

        #student-list {
            margin-top: 1.5rem;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-border);
            transition: background-color 0.2s;
        }
        .student-item:last-child {
            border-bottom: none;
        }
        .student-item:hover {
            background-color: var(--color-accent-light); /* Destaque suave */
        }

        .filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .filters > .form-group {
            flex-grow: 1;
            margin-bottom: 0;
        }
        
        @media (min-width: 850px) {
            .filters {
                grid-template-columns: 1fr 1fr;
            }
        }


        #total-display {
            /* Gradiente sutil no totalizador */
            background: linear-gradient(135deg, var(--color-accent-light) 0%, #ffffff 100%);
            border: 2px solid var(--color-primary);
            color: var(--color-primary-dark);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-light);
        }
        #total-display h3 {
            margin: 0;
            font-size: 1.25rem;
        }
        #total-display #total-amount {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        /* --- Estilo do Calendário --- */
        #class-days-list {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            border-top: 1px solid var(--color-border);
            padding-top: 1rem;
        }
        
        .calendar-header {
            text-align: center;
            font-weight: 500;
            font-size: 0.8rem;
            color: var(--color-secondary);
            padding-bottom: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            background-color: #ffffff; /* Fundo dos dias normais */
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s, transform 0.1s;
        }

        .calendar-day:hover:not(.padding) {
            background-color: var(--color-accent-light);
            box-shadow: var(--shadow-hover); /* Sombra mais forte no hover */
            transform: scale(1.05); /* Efeito de zoom leve */
        }

        .calendar-day.padding {
            background-color: var(--color-light); /* Usa o fundo geral para dias de preenchimento */
            cursor: default;
            color: #b0bec5; /* Cinza mais suave para dias de fora do mês */
            border-color: transparent; /* Borda transparente para dias de fora do mês */
        }
        
        .calendar-day.weekend:not(.padding) {
            color: var(--color-secondary); /* Mantém o cinza para fins de semana */
        }

        .calendar-day.selected {
            /* Dia selecionado com gradiente */
            background: linear-gradient(135deg, var(--color-primary-dark), var(--color-primary));
            color: white;
            border-color: var(--color-primary-dark);
            box-shadow: var(--shadow-light);
            transform: scale(1.02);
        }
        /* --- Fim do Estilo do Calendário --- */

        /* Estilo para "Estado Vazio" com SVG */
        .empty-state {
            text-align: center;
            color: var(--color-secondary);
            padding: 1rem;
            grid-column: 1 / -1; /* Ocupa todo o calendário */
        }

        .empty-state-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 2rem 0;
            color: var(--color-secondary);
        }
        .empty-state-content svg {
            width: 64px;
            height: 64px;
            stroke: var(--color-border);
            stroke-width: 1.5;
            fill: none;
        }
        .empty-state-content p {
            font-size: 1rem;
            font-weight: 500;
            margin: 0;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
            <span>Gestor de Aulas</span>
        </h1>

        <!-- Layout de grade (tela única) -->
        <div class="grid-layout">
            
            <!-- Painel de Alunos -->
            <div class="form-section">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    Gerenciar Alunos
                </h2>
                <form id="student-form">
                    <input type="hidden" id="student-id">
                    <div class="form-group">
                        <label for="student-name">Nome do Aluno</label>
                        <input type="text" id="student-name" placeholder="Ex: João Silva" required>
                    </div>
                    <div class="form-group"> 
                        <label for="student-default-price">Valor Padrão (R$)</label>
                        <input type="number" id="student-default-price" placeholder="Ex: 70.00" min="0" step="0.01" required>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Salvar Aluno</button>
                        <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display: none;">Cancelar Edição</button>
                    </div>
                </form>

                <div id="student-list">
                    <!-- Lista de alunos será populada pelo JS -->
                </div>
            </div>

            <!-- Painel do Calendário -->
            <div class="schedule-section">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    Rastreamento de Aulas
                </h2>

                <div class="filters">
                    <div class="form-group">
                        <label for="month-select">Mês</label>
                        <select id="month-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="student-filter-select">Aluno</label>
                        <select id="student-filter-select">
                            <option value="">Todos os Alunos</option>
                            <!-- Populado pelo JS --></select>
                    </div>
                </div>

                <div id="total-display">
                    <h3 id="total-label">Total a Receber</h3>
                    <span id="total-amount">R$ 0,00</span>
                </div>

                <div id="class-days-list">
                    <!-- Calendário será populado pelo JS -->
                </div>
            </div>

        </div> <!-- Fim .grid-layout -->
    </div> <!-- Fim .container -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Seletores do DOM ---
            const studentForm = document.getElementById('student-form');
            const studentIdInput = document.getElementById('student-id');
            const studentNameInput = document.getElementById('student-name');
            const studentDefaultPriceInput = document.getElementById('student-default-price');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const studentList = document.getElementById('student-list');
            
            const monthSelect = document.getElementById('month-select');
            const studentFilterSelect = document.getElementById('student-filter-select');
            const totalLabel = document.getElementById('total-label');
            const totalAmountEl = document.getElementById('total-amount');
            const classDaysList = document.getElementById('class-days-list');

            // --- Constantes e Estado ---
            const WEEKDAYS = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
            const WEEKDAYS_SHORT = ["D", "S", "T", "Q", "Q", "S", "S"]; 
            const MONTHS = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            
            let students = [];
            let schedules = []; // Estrutura mantida: { id, studentId, date(YYYY-MM-DD), price, status }

            // --- Estados Vazios (SVG + Texto) ---
            const emptyStateStudents = `
                <div class="empty-state-content">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
                    <p>Nenhum aluno cadastrado.</p>
                </div>
            `;
            const emptyStateCalendar = `
                <div class="empty-state">
                    <div class="empty-state-content">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="m9 16 2 2 4-4"></path></svg>
                        <p>Selecione um aluno para lançar as aulas.</p>
                    </div>
                </div>
            `;
            
            // --- Funções Auxiliares ---
            const generateId = () => `id_${new Date().getTime()}_${Math.random().toString(36).substring(2, 9)}`;

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
            };
            
            const formatISODate = (isoDate) => {
                 const [year, month, day] = isoDate.split('-');
                 return `${day}/${month}/${year}`;
            }

            const getDaysInMonth = (month, year) => {
                return new Date(year, month + 1, 0).getDate();
            };
            
            // --- Funções de Persistência (LocalStorage) ---

            const loadFromLocalStorage = () => {
                students = JSON.parse(localStorage.getItem('tutorStudents')) || [];
                schedules = JSON.parse(localStorage.getItem('tutorSchedules')) || []; 
            };

            const saveStudents = () => {
                localStorage.setItem('tutorStudents', JSON.stringify(students));
            };

            const saveSchedules = () => {
                localStorage.setItem('tutorSchedules', JSON.stringify(schedules)); 
            };

            // --- Funções de Gerenciamento de Alunos (CRUD) ---

            const renderStudentList = () => {
                studentList.innerHTML = ''; 
                
                if (students.length === 0) {
                    studentList.innerHTML = emptyStateStudents; // Novo estado vazio
                    return;
                }
                
                const sortedStudents = [...students].sort((a, b) => a.name.localeCompare(b.name));
                
                sortedStudents.forEach(student => {
                    const item = document.createElement('div');
                    item.className = 'student-item';
                    item.innerHTML = `
                        <span>
                            <strong>${student.name}</strong><br>
                            <small>Padrão: ${formatCurrency(student.price)}</small>
                        </span>
                        <div>
                            <button class="btn btn-edit" data-id="${student.id}">Editar</button>
                            <button class="btn btn-danger" data-id="${student.id}">Excluir</button>
                        </div>
                    `;
                    studentList.appendChild(item);
                });
            };

            const resetStudentForm = () => {
                studentForm.reset();
                studentIdInput.value = '';
                cancelEditBtn.style.display = 'none';
                studentForm.querySelector('button[type="submit"]').textContent = 'Salvar Aluno';
            };

            const handleStudentFormSubmit = (e) => {
                e.preventDefault();
                
                const id = studentIdInput.value;
                const name = studentNameInput.value.trim();
                const price = parseFloat(studentDefaultPriceInput.value); 

                if (!name || isNaN(price) || price < 0) { 
                    console.error("Dados inválidos");
                    return;
                }

                if (id) {
                    const index = students.findIndex(s => s.id === id);
                    if (index !== -1) {
                        students[index] = { id, name, price }; 
                    }
                } else {
                    const newStudent = { id: generateId(), name, price }; 
                    students.push(newStudent);
                }

                saveStudents();
                renderStudentList();
                renderStudentFilterDropdown();
                renderMonthCalendar(); // Atualiza o calendário
                resetStudentForm();
            };

            const handleStudentListClick = (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;

                if (target.classList.contains('btn-edit')) {
                    const student = students.find(s => s.id === id);
                    if (student) {
                        studentIdInput.value = student.id;
                        studentNameInput.value = student.name;
                        studentDefaultPriceInput.value = student.price; 
                        
                        cancelEditBtn.style.display = 'inline-block';
                        studentForm.querySelector('button[type="submit"]').textContent = 'Atualizar Aluno';
                        studentNameInput.focus();
                    }
                } else if (target.classList.contains('btn-danger')) {
                    // Excluir
                    students = students.filter(s => s.id !== id);
                    schedules = schedules.filter(s => s.studentId !== id); 
                    
                    saveStudents();
                    saveSchedules();
                    renderStudentList();
                    renderStudentFilterDropdown(); 
                    renderMonthCalendar(); // Atualiza o calendário
                }
            };

            // --- Funções de Rastreamento de Aulas (Calendário) ---

            const renderStudentFilterDropdown = () => {
                const sortedStudents = [...students].sort((a, b) => a.name.localeCompare(b.name));
                const currentSelection = studentFilterSelect.value;
                studentFilterSelect.innerHTML = '<option value="">Todos os Alunos</option>';
                
                sortedStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    studentFilterSelect.appendChild(option);
                });
                
                studentFilterSelect.value = currentSelection;
            };

            const populateFilters = () => {
                const now = new Date();
                const currentMonth = now.getMonth();
                
                monthSelect.innerHTML = '';
                MONTHS.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = month;
                    if (index === currentMonth) {
                        option.selected = true;
                    }
                    monthSelect.appendChild(option);
                });

                studentFilterSelect.value = ""; // Padrão é "Todos os Alunos"
            };
            
            // FUNÇÃO PRINCIPAL ATUALIZADA
            // Renderiza o calendário de dias do mês
            const renderMonthCalendar = () => {
                classDaysList.innerHTML = ''; // Limpa
                
                const selectedMonth = parseInt(monthSelect.value); // 0-11
                const selectedStudentId = studentFilterSelect.value; // Pode ser "" (Todos)
                const currentYear = new Date().getFullYear();

                // 1. Renderiza o cabeçalho (D, S, T, Q, Q, S, S)
                WEEKDAYS_SHORT.forEach(day => {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'calendar-header';
                    headerCell.textContent = day;
                    classDaysList.appendChild(headerCell);
                });

                // 2. Se "Todos" estiver selecionado, mostra estado vazio e calcula total
                if (selectedStudentId === "") {
                    classDaysList.innerHTML += emptyStateCalendar; // Novo estado vazio
                    calculateTotal(); // Calcula o total (geral)
                    return;
                }
                
                const student = students.find(s => s.id === selectedStudentId);
                if (!student) {
                    classDaysList.innerHTML += `
                        <div class="empty-state">
                            <div class="empty-state-content"><p>Erro: Aluno não encontrado.</p></div>
                        </div>`;
                    return;
                }

                // 3. Lógica do Calendário
                const daysInMonth = getDaysInMonth(selectedMonth, currentYear);
                const firstDayOfWeek = new Date(currentYear, selectedMonth, 1).getDay(); // 0=Domingo, 1=Segunda...

                // 4. Renderiza dias de preenchimento (padding)
                for (let i = 0; i < firstDayOfWeek; i++) {
                    const paddingCell = document.createElement('div');
                    paddingCell.className = 'calendar-day padding';
                    classDaysList.appendChild(paddingCell);
                }

                // 5. Renderiza os dias reais do mês
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateObj = new Date(currentYear, selectedMonth, day);
                    const dateISO = `${currentYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    const dayOfWeek = dateObj.getDay();
                    
                    // Verifica se já existe uma aula marcada
                    const existingSchedule = schedules.find(s => s.studentId === selectedStudentId && s.date === dateISO && s.status === 'completed');
                    const isSelected = !!existingSchedule;
                    
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day';
                    dayCell.textContent = day;
                    dayCell.dataset.date = dateISO; // Armazena a data no formato YYYY-MM-DD
                    
                    if (isSelected) {
                        dayCell.classList.add('selected');
                    }
                    if (isWeekend) {
                        dayCell.classList.add('weekend');
                    }
                    
                    classDaysList.appendChild(dayCell);
                }
                
                calculateTotal(); // Atualiza o total (individual) após renderizar
            };
            
            // FUNÇÃO ATUALIZADA
            // Manipulador de clique nos dias do calendário
            const handleDayClick = (e) => {
                const target = e.target;
                
                // Verifica se é um dia clicável (ignora cabeçalho, padding, ou o container)
                if (!target.classList.contains('calendar-day') || target.classList.contains('padding')) {
                    return;
                }

                const dateISO = target.dataset.date;
                const selectedStudentId = studentFilterSelect.value;
                
                if (selectedStudentId === "" || !dateISO) return; // Não faz nada se "Todos" ou data inválida

                const student = students.find(s => s.id === selectedStudentId);
                if (!student) return;
                
                const isCurrentlySelected = target.classList.contains('selected');

                // Remove qualquer agendamento existente para este dia/aluno (para evitar duplicatas)
                schedules = schedules.filter(s => !(s.studentId === selectedStudentId && s.date === dateISO));

                if (!isCurrentlySelected) {
                    // Se não estava selecionado, ADICIONA
                    const newSchedule = {
                        id: generateId(),
                        studentId: selectedStudentId,
                        date: dateISO,
                        price: student.price, // Usa o preço padrão do aluno
                        status: 'completed' // Marcado significa aula dada
                    };
                    schedules.push(newSchedule);
                    target.classList.add('selected'); // Atualiza a UI
                } else {
                    // Se estava selecionado, REMOVE (já foi filtrado acima)
                    target.classList.remove('selected'); // Atualiza a UI
                }
                
                saveSchedules();
                calculateTotal();
            };

            // Calcula e exibe o total (lógica idêntica à versão anterior)
            const calculateTotal = () => {
                const selectedMonth = parseInt(monthSelect.value);
                const selectedStudentId = studentFilterSelect.value; // Pode ser "" (Todos)
                const selectedMonthName = MONTHS[selectedMonth];
                const currentYear = new Date().getFullYear();
                
                let total = 0;

                // Filtra todos os agendamentos do mês/ano
                const schedulesForMonth = schedules.filter(s => {
                    const scheduleDate = new Date(s.date + 'T00:00:00');
                    return s.status === 'completed' &&
                           scheduleDate.getMonth() === selectedMonth && 
                           scheduleDate.getFullYear() === currentYear;
                });

                if (selectedStudentId === "") {
                    // --- MODO TOTAL GERAL ---
                    schedulesForMonth.forEach(schedule => {
                        total += parseFloat(schedule.price);
                    });
                    
                    totalLabel.textContent = `Total Geral em ${selectedMonthName}`;

                } else {
                    // --- MODO ALUNO INDIVIDUAL ---
                    let studentName = "";
                    const student = students.find(s => s.id === selectedStudentId);
                    if (student) {
                        studentName = student.name;
                    }

                    // Filtra os agendamentos do mês PELO ALUNO selecionado
                    const schedulesForStudent = schedulesForMonth.filter(s => s.studentId === selectedStudentId);

                    schedulesForStudent.forEach(schedule => {
                        total += parseFloat(schedule.price);
                    });
                    
                    if (studentName) {
                        totalLabel.textContent = `Total de ${studentName} em ${selectedMonthName}`;
                    } else {
                        totalLabel.textContent = `Total a Receber`; // Fallback
                    }
                }
                
                totalAmountEl.textContent = formatCurrency(total);
            };

            // --- Inicialização ---
            
            const init = () => {
                loadFromLocalStorage();
                populateFilters(); // Popula o mês
                renderStudentList();
                renderStudentFilterDropdown(); // Popula o filtro de alunos
                renderMonthCalendar(); // Renderiza o calendário

                // Listeners dos Alunos
                studentForm.addEventListener('submit', handleStudentFormSubmit);
                studentList.addEventListener('click', handleStudentListClick);
                cancelEditBtn.addEventListener('click', resetStudentForm);
                
                // Listeners dos Filtros e Calendário
                monthSelect.addEventListener('change', renderMonthCalendar);
                studentFilterSelect.addEventListener('change', renderMonthCalendar);
                classDaysList.addEventListener('click', handleDayClick); 
            
                // Lógica das abas foi REMOVIDA
            };

            init();
        });
    </script>
</body>
</html>

